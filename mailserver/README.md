# nameinahat.com Mail Server

Secure, production-ready mail server setup for nameinahat.com domain using Docker Mailserver.

## ğŸ¯ Features

- âœ… **Complete SMTP/IMAP Server** - Full mail server functionality
- ğŸ” **Security Hardened** - DKIM, SPF, DMARC, SSL/TLS, Fail2Ban
- ğŸ›¡ï¸ **Spam Protection** - SpamAssassin, ClamAV, Postgrey
- ğŸ”’ **Encrypted Storage** - Mail data encryption at rest
- ğŸ“Š **Monitoring Ready** - Comprehensive logging and health checks
- ğŸš€ **Production Ready** - Docker-based, scalable, maintainable

## ğŸš€ Quick Start

### 1. Initial Setup
```bash
# Run the setup script to generate DKIM keys and mail accounts
./setup-mailserver.sh

# Setup SSL certificates (choose your preferred method)
./setup-ssl.sh
```

### 2. Configure DNS
Follow the instructions in `DNS_SETUP.md` to configure:
- MX records
- SPF records  
- DKIM records
- DMARC policy

### 3. Start Mail Server
```bash
# Start the mail server
./mailctl.sh start

# Check status
./mailctl.sh status

# Test configuration
./mailctl.sh test
```

## ğŸ“§ Mail Accounts

The setup creates these mail accounts:

| Account | Purpose | Usage |
|---------|---------|--------|
| `secretsanta@nameinahat.com` | Application | Secret Santa app sending |
| `noreply@nameinahat.com` | System | Automated notifications |
| `admin@nameinahat.com` | Administration | Server management |

Credentials are securely stored in `.mail-credentials` file.

## ğŸ”§ Configuration

### Mail Server Settings
- **SMTP Submission**: Port 2587 (TLS required)
- **SMTPS**: Port 2465 (SSL)
- **IMAP**: Port 2143 (STARTTLS)
- **IMAPS**: Port 2993 (SSL)

### Security Features
- **DKIM Signing** - Email authentication
- **SPF Validation** - Sender verification  
- **DMARC Policy** - Domain protection
- **TLS Encryption** - Transport security
- **Fail2Ban** - Brute force protection
- **ClamAV** - Virus scanning
- **SpamAssassin** - Spam filtering

## ğŸ› ï¸ Management Commands

Use the `mailctl.sh` script for all management tasks:

```bash
./mailctl.sh start      # Start mail server
./mailctl.sh stop       # Stop mail server  
./mailctl.sh restart    # Restart mail server
./mailctl.sh logs       # View server logs
./mailctl.sh status     # Check server status
./mailctl.sh test       # Test configuration
./mailctl.sh adduser    # Add new email user
./mailctl.sh backup     # Backup mail data
./mailctl.sh restore    # Restore from backup
```

## ğŸ“ Directory Structure

```
mailserver/
â”œâ”€â”€ docker-compose.yml          # Container configuration
â”œâ”€â”€ setup-mailserver.sh         # Initial setup script
â”œâ”€â”€ setup-ssl.sh               # SSL certificate setup
â”œâ”€â”€ mailctl.sh                 # Management script
â”œâ”€â”€ DNS_SETUP.md               # DNS configuration guide
â”œâ”€â”€ config/                    # Mail server configuration
â”‚   â”œâ”€â”€ postfix-accounts.cf    # Mail user accounts
â”‚   â”œâ”€â”€ dovecot-quotas.cf      # Mailbox quotas
â”‚   â””â”€â”€ opendkim/              # DKIM configuration
â”‚       â”œâ”€â”€ KeyTable           # DKIM key table
â”‚       â”œâ”€â”€ SigningTable       # DKIM signing table
â”‚       â”œâ”€â”€ TrustedHosts       # DKIM trusted hosts
â”‚       â””â”€â”€ keys/nameinahat.com/
â”‚           â”œâ”€â”€ mail.private   # DKIM private key
â”‚           â””â”€â”€ mail.public    # DKIM public key
â”œâ”€â”€ data/                      # Mail data (auto-created)
â”‚   â”œâ”€â”€ maildata/             # Mail storage
â”‚   â””â”€â”€ mailstate/            # Mail server state
â”œâ”€â”€ ssl/                       # SSL certificates
â”‚   â”œâ”€â”€ fullchain.pem         # SSL certificate chain
â”‚   â””â”€â”€ privkey.pem           # SSL private key
â””â”€â”€ .mail-credentials         # Account credentials (keep secure!)
```

## ğŸ” Security Considerations

### SSL/TLS Certificates
- Use Let's Encrypt for production (free, auto-renewal)
- Self-signed certificates for testing only
- Certificates must be valid for `mail.nameinahat.com`

### Firewall Rules
Ensure these ports are open on your server:
```bash
# SMTP submission
sudo ufw allow 2587/tcp

# SMTPS  
sudo ufw allow 2465/tcp

# IMAP
sudo ufw allow 2143/tcp

# IMAPS
sudo ufw allow 2993/tcp
```

### Backup Strategy
- Regular backups: `./mailctl.sh backup`
- Store backups securely off-server
- Test restore procedures regularly

## ğŸŒ DNS Requirements

### Essential Records (GoDaddy)
Add these records to nameinahat.com DNS:

1. **MX Record**: `@ â†’ mail.nameinahat.com (priority 10)`
2. **A Record**: `mail â†’ 172.233.171.101`  
3. **SPF TXT**: `@ â†’ v=spf1 mx a:mail.nameinahat.com ip4:172.233.171.101 ~all`
4. **DKIM TXT**: `mail._domainkey â†’ [generated by setup script]`
5. **DMARC TXT**: `_dmarc â†’ v=DMARC1; p=quarantine; rua=mailto:admin@nameinahat.com`

## ğŸ§ª Testing

### SMTP Test
```bash
# Test SMTP connection
telnet 172.233.171.101 2587

# Send test email (replace with your details)
echo "Test message" | mail -s "Test" -S smtp=172.233.171.101:2587 test@example.com
```

### Mail Flow Test
```bash
# Check mail delivery
./mailctl.sh logs | grep "delivered"

# Check for errors
./mailctl.sh logs | grep -i error
```

### Online Tools
- https://mxtoolbox.com/domain/nameinahat.com
- https://www.mail-tester.com/
- https://dmarcanalyzer.com/

## ğŸš¨ Troubleshooting

### Common Issues

**Mail rejected as spam:**
- Verify SPF, DKIM, DMARC records
- Check server reputation
- Ensure reverse DNS is configured

**Cannot connect to server:**
- Check firewall rules
- Verify SSL certificates
- Test port connectivity

**Mail not delivered:**
- Check logs: `./mailctl.sh logs`
- Verify DNS records
- Test with mail-tester.com

### Debug Commands
```bash
# Check container status
docker ps -a

# Inspect mail container
docker inspect nameinahat-mailserver

# Check mail queue
docker exec nameinahat-mailserver postqueue -p

# Test DNS resolution
dig MX nameinahat.com
dig TXT mail._domainkey.nameinahat.com
```

## ğŸ“ˆ Monitoring

### Health Checks
```bash
# Server status
./mailctl.sh status

# Test all services
./mailctl.sh test

# Monitor logs in real-time
./mailctl.sh logs
```

### Performance Metrics
- Mail queue size: Check with postqueue
- Disk usage: Monitor data/ directory
- Memory usage: Check container stats
- Connection counts: Monitor logs

## ğŸ”„ Maintenance

### Regular Tasks
- **Weekly**: Check logs for errors
- **Monthly**: Verify SSL certificate expiration
- **Quarterly**: Update container image
- **Annually**: Review and update DMARC policy

### Updates
```bash
# Update mail server image
docker-compose pull
docker-compose up -d

# Backup before updates
./mailctl.sh backup
```

## ğŸ“ Support

For issues or questions:
1. Check logs: `./mailctl.sh logs`
2. Run tests: `./mailctl.sh test`
3. Consult troubleshooting section
4. Review online mail testing tools

---

**Production Checklist:**
- [ ] DNS records configured and propagated
- [ ] SSL certificates installed and valid
- [ ] DKIM keys generated and DNS record added
- [ ] SPF record configured
- [ ] DMARC policy set
- [ ] Firewall rules configured
- [ ] Mail accounts created
- [ ] Test email sent and received
- [ ] Backup strategy implemented